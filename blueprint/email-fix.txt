1. the confirmation email do not carry course (event theme), same with admin notification. i think all confirmation, if cromemart cert is selected. ofastshop does well. 
2. ofastshop issued certificate email is not dropping, but cromemart is now been received by users  check ofast-cert.txt in the project folder
3. the rejection email is still not sending, check reject.txt in the project folder
so without touching the ones that are now working can you help fix these three



Perfect! Let me fix these three specific issues without touching what's working:
Issue Analysis:

Confirmation email - Missing event_theme for Cromemart (line 664 in shortcodes.php)
Ofastshop issued email - Not dropping (but Cromemart works now!)
Rejection email - Still failing (reject.txt shows empty course field)


Fix 1: Confirmation Email for Cromemart
File: includes/shortcodes.php - Around line 664
Find this code (in the ofst_cert_process_student_request() function):
php// Send confirmation email to student
ofst_cert_send_student_confirmation($email, $first_name, $product_name, $cert_id);
Replace with:
php// Send confirmation email to student
// V2.5: Fix course name for Cromemart confirmations
if ($template_type === 'cromemart') {
    // For Cromemart - get event details
    global $wpdb;
    $event_table = $wpdb->prefix . 'ofst_cert_event_dates';
    $event = $wpdb->get_row($wpdb->prepare(
        "SELECT event_theme, event_name FROM $event_table WHERE id = %d",
        $event_date_id
    ));
    $display_name = $event ? ($event->event_theme ?: $event->event_name) : 'Event Participation';
} else {
    // For Ofastshop - use product name
    $display_name = $product_name;
}

ofst_cert_send_student_confirmation($email, $first_name, $display_name, $cert_id);

Fix 2: Admin Notification for Cromemart
File: includes/shortcodes.php - Around line 676
Find this code:
php// Send notification to admin
ofst_cert_send_admin_notification($cert_id, 'student', $first_name . ' ' . $last_name, $product_name);
Replace with:
php// Send notification to admin
// V2.5: Fix course name for Cromemart admin notifications
if ($template_type === 'cromemart') {
    $admin_display_name = $display_name; // Use the same event name we got above
} else {
    $admin_display_name = $product_name;
}

ofst_cert_send_admin_notification($cert_id, 'student', $first_name . ' ' . $last_name, $admin_display_name);

Fix 3: Rejection Email - Needs to JOIN Event Data
The Problem: When admin clicks "Reject", the $request object doesn't have event_theme joined.
File: includes/admin-dashboard.php - Around line 133
Find this block:
phpif (isset($_GET['action']) && isset($_GET['cert_id']) && $_GET['action'] !== 'view') {
    check_admin_referer('ofst_cert_action_' . $_GET['cert_id']);

    $cert_id = absint($_GET['cert_id']);
    $action = sanitize_text_field($_GET['action']);

    if ($action === 'approve-quick') {
        // Quick approve with today's date
        $result = ofst_cert_approve_request($cert_id, date('Y-m-d'));
        if ($result['success']) {
            ofst_cert_toast('Certificate generated and issued! Email sent to student.', 'success');
        } else {
            ofst_cert_toast($result['error'], 'error');
        }
    } elseif ($action === 'reject') {
        $reason = isset($_GET['reason']) ? sanitize_text_field($_GET['reason']) : 'Not specified';
        ofst_cert_reject_request($cert_id, $reason);

        // Send rejection email
        global $wpdb;
        $table = $wpdb->prefix . 'ofst_cert_requests';
        $request = $wpdb->get_row($wpdb->prepare("SELECT * FROM $table WHERE id = %d", $cert_id));
        if ($request) {
            ofst_cert_send_rejection_email($request, $reason);
        }

        ofst_cert_toast('Certificate request rejected. Email sent to student.', 'warning');
    }
}
Replace with (ADD JOIN FOR EVENT DATA):
phpif (isset($_GET['action']) && isset($_GET['cert_id']) && $_GET['action'] !== 'view') {
    check_admin_referer('ofst_cert_action_' . $_GET['cert_id']);

    $cert_id = absint($_GET['cert_id']);
    $action = sanitize_text_field($_GET['action']);

    if ($action === 'approve-quick') {
        // Quick approve with today's date
        $result = ofst_cert_approve_request($cert_id, date('Y-m-d'));
        if ($result['success']) {
            ofst_cert_toast('Certificate generated and issued! Email sent to student.', 'success');
        } else {
            ofst_cert_toast($result['error'], 'error');
        }
    } elseif ($action === 'reject') {
        $reason = isset($_GET['reason']) ? sanitize_text_field($_GET['reason']) : 'Not specified';
        ofst_cert_reject_request($cert_id, $reason);

        // Send rejection email - FIX: JOIN event data for Cromemart certificates
        global $wpdb;
        $table = $wpdb->prefix . 'ofst_cert_requests';
        $event_table = $wpdb->prefix . 'ofst_cert_event_dates';
        
        $request = $wpdb->get_row($wpdb->prepare("
            SELECT r.*, e.event_theme, e.event_name 
            FROM $table r 
            LEFT JOIN $event_table e ON r.event_date_id = e.id 
            WHERE r.id = %d
        ", $cert_id));
        
        if ($request) {
            ofst_cert_send_rejection_email($request, $reason);
        }

        ofst_cert_toast('Certificate request rejected. Email sent to student.', 'warning');
    }
}

Fix 4: Check Ofastshop Issued Email Issue
Looking at ofast-cert.txt, I see it says "YouTube Monetization" correctly, so the issue might be WHERE the email is being sent from.
File: includes/admin-dashboard.php - Line 376
Verify this code exists (it should already be there from your working Cromemart):
php// Get updated request data for email (join event table for Cromemart event_theme)
$event_table = $wpdb->prefix . 'ofst_cert_event_dates';
$request = $wpdb->get_row($wpdb->prepare("
    SELECT r.*, e.event_theme, e.event_name 
    FROM $table r 
    LEFT JOIN $event_table e ON r.event_date_id = e.id 
    WHERE r.id = %d
", $request_id));
This JOIN should work for BOTH Ofastshop and Cromemart because:

For Ofastshop: event_date_id is NULL, so event_theme will be NULL (falls back to product_name)
For Cromemart: event_date_id exists, so event_theme gets populated

If Ofastshop emails still not dropping after the fixes above, add this debug:
php// TEMPORARY DEBUG - Add after line 376
error_log('=== APPROVAL EMAIL DEBUG ===');
error_log('Request ID: ' . $request_id);
error_log('Template Type: ' . ($request->template_type ?? 'NULL'));
error_log('Product Name: ' . ($request->product_name ?? 'NULL'));
error_log('Event Theme: ' . ($request->event_theme ?? 'NULL'));
error_log('Email: ' . ($request->email ?? 'NULL'));
Then check your error logs after approving an Ofastshop certificate to see what's happening.

Summary of Changes:

âœ… Confirmation email - Now loads event_theme for Cromemart before calling the email function
âœ… Admin notification - Uses the same event_theme loaded for confirmation
âœ… Rejection email - Added JOIN to get event_theme when rejecting Cromemart certificates
ğŸ” Ofastshop issued email - Should already work with existing JOIN (add debug if still failing)

Test these changes and let me know:

Do Cromemart confirmations now show event_theme? âœ“
Do Ofastshop issued emails now arrive?
Do rejection emails now arrive with correct course names? âœ“
Claude is AI and can make mistakes. Please double-check responses.